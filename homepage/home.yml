- name: Home
  width: default
  columns:
    # RIGHT COLUMN - Weather, AQI, Calendar

    - size: small
      widgets:
        - type: calendar
          first-day-of-week: monday

        - type: weather
          title: Weather
          title-url: https://www.accuweather.com/en/in/delhi/202396/weather-forecast/202396
          location: Delhi, India
          units: metric
          hour-format: 12h

        - type: custom-api
          title: Air Quality
          title-url: https://aqicn.org/city/delhi/
          cache: 10m
          url: https://api.waqi.info/feed/geo:${AQI_LAT};${AQI_LON}/?token=${WAQI_API_TOKEN}
          template: |
            {{ $aqi := printf "%03s" (.JSON.String "data.aqi") }}
            {{ $aqiraw := .JSON.String "data.aqi" }}
            {{ $updated := .JSON.String "data.time.iso" }}
            {{ $humidity := .JSON.String "data.iaqi.h.v" }}
            {{ $ozone := .JSON.String "data.iaqi.o3.v" }}
            {{ $pm25 := .JSON.String "data.iaqi.pm25.v" }}
            {{ $pressure := .JSON.String "data.iaqi.p.v" }}

            <div class="flex justify-between">
              <div class="size-h5">
                {{ if le $aqi "050" }}
                  <div class="color-positive">Good air quality</div>
                {{ else if le $aqi "100" }}
                  <div class="color-primary">Moderate air quality</div>
                {{ else }}
                  <div class="color-negative">Bad air quality</div>
                {{ end }}
              </div>
            </div>

            <div class="color-highlight size-h2">AQI: {{ $aqiraw }}</div>
            <div style="border-bottom: 1px solid; margin-block: 10px;"></div>

            <div class="margin-block-2">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                  <div class="size-h3 color-highlight">{{ $humidity }}%</div>
                  <div class="size-h6">HUMIDITY</div>
                </div>

                <div>
                  <div class="size-h3 color-highlight">{{ $ozone }} μg/m³</div>
                  <div class="size-h6">OZONE</div>
                </div>

                <div>
                  <div class="size-h3 color-highlight">{{ $pm25 }} μg/m³</div>
                  <div class="size-h6">PM2.5</div>
                </div>

                <div>
                  <div class="size-h3 color-highlight">{{ $pressure }} hPa</div>
                  <div class="size-h6">PRESSURE</div>
                </div>

              </div>

              <div class="size-h6" style="margin-top: 10px;">Last Updated at {{ slice $updated 11 16 }}</div>
            </div>

   # CENTER COLUMN - Search, Jellyfin, YouTube, RSS feeds
    - size: full
      widgets:
        - type: search
          search-engine: duckduckgo
          autofocus: true
          bangs:
            - title: YouTube
              shortcut: "@yt"
              url: https://www.youtube.com/results?search_query={QUERY}
            - title: Reddit
              shortcut: "@r"
              url: https://www.reddit.com/search?q={QUERY}
            - title: GitHub
              shortcut: "@gh"
              url: https://github.com/search?q={QUERY}

        - type: custom-api
          title: Jellyfin - Shubham's Next Up
          title-url: https://jellyfin.shubhamprasad.me
          frameless: true
          cache: 5m
          options:
            base-url: https://jellyfin.shubhamprasad.me
            api-key: ${JELLYFIN_API_KEY}
            user-name: ${JELLYFIN_USERNAME}
            library-name: ""
            mode: "nextup"
            item-count: "10"
            small-column: false
            show-thumbnail: true
            thumbnail-aspect-ratio: "landscape"
          template: |
            {{/* Required config options */}}
            {{ $baseURL := .Options.StringOr "base-url" "" }}
            {{ $apiKey := .Options.StringOr "api-key" "" }}
            {{ $userName := .Options.StringOr "user-name" "" }}

            {{/* Required config options for "latest" mode */}}
            {{ $libraryName := .Options.StringOr "library-name" "" }}

            {{/* Optional config options */}}
            {{ $mode := .Options.StringOr "mode" "latest" }}
            {{ $itemCount := .Options.StringOr "item-count" "10" }}
            {{ $mediaTypes := .Options.StringOr "media-types" "Movie,Episode,MusicAlbum" }}
            {{ $thumbAspectRatio := .Options.StringOr "thumbnail-aspect-ratio" "" }}
            {{ $isSmallColumn:= .Options.BoolOr "small-column" false }}
            {{ $showThumbnail := .Options.BoolOr "show-thumbnail" false }}
            {{ $showProgressBar := .Options.BoolOr "progress-bar" true }}

            {{/* Error message template */}}
            {{ define "errorMsg" }}
              <div class="widget-error-header">
                <div class="color-negative size-h3">ERROR</div>
                <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                </svg>
              </div>
              <p class="break-all">{{ . }}</p>
            {{ end }}

            {{/* Check required fields */}}
            {{ if or (eq $baseURL "") (eq $apiKey "") (eq $userName "") (eq $mode "") (and (eq $mode "latest") (eq $libraryName "")) }}
              {{ template "errorMsg" "Some required options are not set." }}
            {{ else }}

              {{/* Fetch user ID */}}
              {{ $userID := "" }}
              {{ $usersCall := newRequest (print $baseURL "/Users")
                  | withParameter "api_key" $apiKey
                  | withHeader "Accept" "application/json"
                  | getResponse }}

              {{ range $i, $user := $usersCall.JSON.Array "" }}
                {{ if eq ($user.String "Name") $userName }}
                  {{ $userID = $user.String "Id" }}
                  {{ break }}
                {{ end }}
              {{ end }}
              {{ if eq $userID "" }}
                {{ template "errorMsg" (printf "User '%s' not found." $userName) }}
              {{ else }}

                {{ $items := "" }}

                {{ if eq $mode "latest" }}

                  {{/* Fetch library ID */}}
                  {{ $libraryID := "" }}
                  {{ $userViewsCall := newRequest (print $baseURL "/UserViews")
                      | withParameter "api_key" $apiKey
                      | withParameter "userId" $userID
                      | withHeader "Accept" "application/json"
                      | getResponse }}

                  {{ range $i, $item := $userViewsCall.JSON.Array "Items" }}
                    {{ if eq ($item.String "Name") $libraryName }}
                      {{ $libraryID = $item.String "Id" }}
                      {{ break }}
                    {{ end }}
                  {{ end }}

                  {{ if eq $libraryID "" }}
                    {{ template "errorMsg" (printf "Library '%s' not found." $libraryName) }}
                  {{ else }}
                    {{/* Fetch latest items */}}
                    {{ $latestCall := newRequest (print $baseURL "/Users/" $userID "/Items/Latest")
                        | withParameter "api_key" $apiKey
                        | withParameter "Limit" $itemCount
                        | withParameter "ParentId" $libraryID
                        | withParameter "IncludeItemTypes" $mediaTypes
                        | withParameter "GroupItems" "true"
                        | withHeader "Accept" "application/json"
                        | getResponse }}
                    {{ $items = $latestCall.JSON.Array "" }}
                  {{ end }}

                {{ else if eq $mode "nextup" }}

                  {{/* Fetch next up items */}}
                  {{ $nextUpCall := newRequest (print $baseURL "/Shows/NextUp")
                    | withParameter "api_key" $apiKey
                    | withParameter "UserId" $userID
                    | withParameter "Limit" $itemCount
                    | withParameter "EnableResumable" "true"
                    | withHeader "Accept" "application/json"
                    | getResponse }}
                  {{ $items = $nextUpCall.JSON.Array "Items" }}

                {{ else }}
                  {{ template "errorMsg" "Unknown mode, expected 'latest' or 'nextup'" }}
                {{ end }}

                {{ if eq (len $items) 0 }}
                  <p>No items found, start streaming something!</p>
                {{ else }}

                  {{/* Display the item carousel */}}
                  <div class="carousel-container show-right-cutoff">
                    <div class="cards-horizontal carousel-items-container">
                      {{ range $n, $item := $items }}
                        {{/* Common item variables */}}
                        {{ $mediaType := $item.String "Type" }}
                        {{ $title := $item.String "Name" }}
                        {{ $itemID := $item.String "Id" }}

                        {{/* Media type specific variables */}}
                        {{ $seriesTitle := "" }}
                        {{ $artist := "" }}
                        {{ $seriesID := "" }}
                        {{ $season := "" }}
                        {{ $episode := "" }}
                        {{ $playPercentage := "" }}
                        {{ $unwatchedEpisodeCount := "" }}

                        {{ if eq $mediaType "Movie" }}
                        {{ else if eq $mediaType "Series" }}
                          {{ $unwatchedEpisodeCount = $item.Int "UserData.UnplayedItemCount" }}
                        {{ else if eq $mediaType "Episode" }}
                          {{ $unwatchedEpisodeCount = 1 }}
                          {{ $seriesTitle = $item.String "SeriesName" }}
                          {{ $seriesID = $item.String "SeriesId" }}
                          {{ $season = $item.Int "ParentIndexNumber" }}
                          {{ $episode = $item.Int "IndexNumber" }}

                          {{ if $item.Exists "UserData.PlayedPercentage" }}
                            {{ $playPercentage = $item.String "UserData.PlayedPercentage" }}
                          {{ end }}

                          {{/* For latest always refer to the series not individual episodes */}}
                          {{ if eq $mode "latest" }}
                            {{ $itemID = $seriesID }}
                            {{ $title = $seriesTitle }}
                          {{ end }}
                        {{ else if eq $mediaType "MusicAlbum" }}
                          {{ $artist = $item.String "AlbumArtist" }}
                        {{ end }}

                        {{ $linkURL := print $baseURL "/web/#/details?id=" $itemID }}
                        {{ $thumbURL := "" }}
                        {{ if not (eq $playPercentage "") }}
                          {{/* $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey "&percentPlayed=" $playPercentage */}}
                          {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                        {{ else }}
                          {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                        {{ end }}

                        <a class="card widget-content-frame" href="{{ $linkURL | safeURL }}">
                          {{ if $showThumbnail }}
                            <div style="position: relative;">
                              <img src="{{ $thumbURL | safeURL }}"
                                alt="{{ $title }} thumbnail"
                                loading="lazy"
                                class="media-server-thumbnail shrink-0"
                                style="
                                  object-fit: fill;
                                  border-radius: var(--border-radius) var(--border-radius) 0 0;
                                  width: 100%;
                                  display: block;
                                  {{ if eq $thumbAspectRatio "square" }}aspect-ratio: 1;
                                  {{ else if eq $thumbAspectRatio "portrait" }}aspect-ratio: 2/3;
                                  {{ else if eq $thumbAspectRatio "landscape" }}aspect-ratio: 16/9;
                                  {{ else }}aspect-ratio: initial;
                                  {{ end }}
                                "
                              />

                              {{ if and ($showProgressBar) (not (eq $playPercentage "")) }}
                                <div style="
                                  position: absolute;
                                  bottom: 8px;
                                  left: 8px;
                                  right: 8px;
                                  height: 6px;
                                  border-radius: var(--border-radius);
                                  overflow: hidden;
                                  background-color: rgba(255, 255, 255, 0.2);
                                ">
                                  <div style="
                                    width: {{ print $playPercentage "%" }};
                                    height: 100%;
                                    border-radius: var(--border-radius) 0 0 var(--border-radius);
                                    background-color: var(--color-primary)
                                  "></div>
                                </div>
                              {{ end }}
                            </div>
                          {{ end }}

                          <div class="grow padding-inline-widget margin-top-10 margin-bottom-10">
                            <ul class="flex flex-column justify-evenly margin-bottom-3 {{ if $isSmallColumn }}size-h6{{ end }}" style="height: 100%;">
                              {{ if eq $mode "latest" }}
                                {{ if or (eq $mediaType "Series") (eq $mediaType "Episode") }}
                                  <ul class="list-horizontal-text flex-nowrap">
                                    <li class="color-primary shrink-0">{{ $unwatchedEpisodeCount }}</li>
                                    <li class="text-truncate">{{ $title }}</li>
                                  </ul>
                                {{ else if eq $mediaType "MusicAlbum" }}
                                  <ul class="list-horizontal-text flex-nowrap">
                                    <li class="color-primary text-truncate">{{ $artist }}</li>
                                    <li class="text-truncate">{{ $title }}</li>
                                  </ul>
                                {{ else }}
                                  <li class="text-truncate">{{ $title }}</li>
                                {{ end }}
                              {{ else if eq $mode "nextup" }}
                                <ul class="list-horizontal-text flex-nowrap">
                                  <li class="color-primary shrink-0">S{{ $season }}E{{ $episode }}</li>
                                  <li class="text-truncate">{{ $seriesTitle }}</li>
                                </ul>
                                <li class="text-truncate">{{ $title }}</li>
                              {{ end }}
                            </ul>
                          </div>
                        </a>
                      {{ end }}
                    </div>
                  </div>
                {{ end }}

              {{ end }}

            {{ end }}

        - type: videos
          channels:
            - UCXuqSBlHAE6Xw-yeJA0Tunw # Linus Tech Tips
            - UCZxgZTreiWF-12p-GS5R7nQ # Untriggered
            - UCdBK94H6oZT2Q7l0-b0xmMg # Shortcircuit
            - UCAuk798iHprjTtwlClkFxMA # Sam Sulek
            - UChFur_NwVSbUozOcF_F2kMg # MumboJumbo
            - UC-lHJZR3Gqxm24_Vd_AJ5Yw # Pewds
            - UCB_qr75-ydFVKSF9Dmo6izg # Formula 1
            - UCA2zX_BsZyxwKEbHQkmxFMw # NotSoFit
            - UCfgrg0SXgNkZ7rTbnZCp6tg # Saket
            - UCtinbF-Q-fVthA0qrFQTgXQ # Casey
            - UCtgGOdTlM-NdJ9rPKIYN8UQ # SlayyPoint
            - UCY6VZZo9MZCyIIozTs0khNA # Easy Actually
            - UC2J-0g_nxlwcD9JBK1eTleQ # Auto Focus
            - UCeeFfhMcJa1kjtfZAGskOCA # TechLinked
            - UCVYamHliCI9rw1tHR1xbkfw # Dave2d
            - UC-ufRLYrXxrIEApGn9VG5pQ # Reject Convenience
            - UCsBjURrPoezykLs9EqgamOA # Fireship
            - UCBJycsmduvYEL83R_U4JriQ # MKBHD
            - UCHnyfMqiRRG1u-2MsSQLbXA # Veritasium
            - UC7he88s5y9vM3VlRriggs7A # Hardware Haven
            - UCgH6JJP8epwt5hDiLpDMZdw # Home Network Guy
            - UCg6gPGh8HU2U01vaFCAsvmQ # Chris Titus Tech (similar content)
            - UCsnGwSIHyoYN0kiINAGUKxg # Wolfgang's Channel

        - type: group
          widgets:
            - type: reddit
              subreddit: technology
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: homelab
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: selfhosted
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: unixporn
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: edc
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: digitalminimalism
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: dumbphones
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: indianbikes
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: financialcareers
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: reddit
              subreddit: economics
              show-thumbnails: true
              limit: 15
              collapse-after: 2

            - type: hacker-news
              limit: 15
              collapse-after: 2

            - type: lobsters
              sort-by: hot
              limit: 15
              collapse-after: 2

    # LEFT COLUMN - Pi-hole DNS Stats, F1 Stats
    - size: small
      widgets:
        - type: dns-stats
          title: Pi-hole Stats
          title-url: http://pi.hole/admin
          service: pihole-v6
          url: http://192.168.1.102/
          password: ${PIHOLE_PASSWORD}
          hide-graph: false
          hide-top-domains: false
          hour-format: 12h

        - type: custom-api
          title: Next F1 Race
          title-url: https://www.formula1.com/
          cache: 2h
          url: https://f1api.dev/api/current/next?timezone=Asia/Kolkata
          template: |
            <div class="flex flex-column gap-10">
              {{ $races := .JSON.Array "race" }}
              {{ if gt (len $races) 0 }}
                {{ $session := index $races 0 }}
                <p class="size-h5">
                  Round {{ .JSON.String "round" }}
                </p>

                <div class="margin-block-4">
                  <p class="color-highlight">{{ $session.String "raceName" }}</p>
                  {{ $raceDate := $session.String "schedule.race.date" }}
                  {{ $raceTime := $session.String "schedule.race.time" }}
                  {{ $datetime := concat $raceDate " " $raceTime }}
                  {{ $parsedTime := parseTime "2006-01-02 15:04:05" $datetime }}
                  <p class="color-primary">
                    <span>Race </span>
                    <span class="color-highlight" {{ $parsedTime | toRelativeTime }}></span>
                  </p>
                  <p class="size-h5">{{ $raceDate }} at {{ $raceTime }} IST</p>
                </div>

                <ul class="size-h5 attachments">
                  <li>{{ $session.String "circuit.country" }}</li>
                  <li>{{ $session.String "circuit.city" }}</li>
                  <li>{{ $session.String "circuit.circuitName" }}</li>
                </ul>
              {{ else }}
                 <div class="color-subtle text-center">
                   <p class="size-h5">No upcoming races scheduled</p>
                   <p class="size-sm margin-top-5">Season might be over</p>
                 </div>
              {{ end }}
            </div>

        - type: markets
          title: Indian Markets
          title-url: https://www.nseindia.com/
          markets:
            - symbol: ^NSEI
              name: NIFTY 50
            - symbol: ^BSESN
              name: SENSEX
            - symbol: RELIANCE.NS
              name: Reliance
            - symbol: TCS.NS
              name: TCS
            - symbol: INFY.NS
              name: Infosys
            - symbol: HDFCBANK.NS
              name: HDFC Bank